# دليل حل مشاكل Google AI Studio TTS

## المشكلة الحالية

**الخطأ**: "فشل توليد الصوت: لم يتم استلام ملف صوتي من Google TTS"

## الحلول المطبقة

### 1. تحديث نقطة النهاية ✅
```
من: /api-google-tts/v1/text:synthesize
إلى: /api-google-ai-studio/v1/text:synthesize
```

### 2. تبسيط هيكل الطلب ✅
```json
// قبل (معقد)
{
  "input": { "text": "..." },
  "voice": { "languageCode": "ar-XA", "name": "..." },
  "audioConfig": { "audioEncoding": "MP3", ... }
}

// بعد (بسيط)
{
  "text": "...",
  "languageCode": "ar",
  "voiceName": "...",
  "speakingRate": 1.0,
  "pitch": 0.0,
  "audioEncoding": "MP3"
}
```

### 3. معالجة استجابة مرنة ✅
الكود الآن يدعم:
- استجابة JSON مع `audioContent` أو `audio` أو `data`
- استجابة Binary مباشرة

### 4. سجلات تفصيلية ✅
```
✅ طلب Google AI Studio TTS
✅ محتوى الطلب
✅ حالة الاستجابة
✅ نوع المحتوى
✅ استجابة JSON (المفاتيح)
✅ محتوى الاستجابة (عند الخطأ)
```

## خطوات التصحيح

### الخطوة 1: افتح Console المتصفح
اضغط F12 أو انقر بزر الماوس الأيمن → Inspect → Console

### الخطوة 2: جرب توليد صوت
1. أدخل نص بسيط: "مرحبا"
2. اختر صوت
3. اضغط "توليد الصوت"

### الخطوة 3: راقب السجلات
ابحث عن:

#### ✅ إذا نجح
```
طلب Google AI Studio TTS: {...}
محتوى الطلب: {...}
حالة الاستجابة: 200 OK
نوع المحتوى: application/json
استجابة JSON: ["audioContent"]
تم توليد الصوت بنجاح: {size: 45678, type: "audio/mpeg"}
```

#### ❌ إذا فشل
```
خطأ في Google AI Studio API: {
  status: 401 أو 400 أو 500,
  statusText: "...",
  error: "..."
}
```

أو

```
محتوى الاستجابة: {...}
لم يتم استلام ملف صوتي من Google AI Studio
```

### الخطوة 4: تحليل الخطأ

#### حالة 401 - Unauthorized
**المشكلة**: مفتاح API غير صحيح أو غير موجود

**الحل**:
1. تواصل مع فريق Backend
2. تحقق من مفتاح Google AI Studio API
3. تحقق من صلاحيات المفتاح

#### حالة 400 - Bad Request
**المشكلة**: طلب غير صالح

**الحل**:
1. انسخ "محتوى الطلب" من console
2. تحقق من:
   - النص غير فارغ
   - اسم الصوت صحيح
   - القيم الرقمية صحيحة

#### حالة 404 - Not Found
**المشكلة**: نقطة النهاية غير موجودة

**الحل**:
1. تحقق من أن Backend يوفر:
   ```
   POST /api-google-ai-studio/v1/text:synthesize
   ```
2. تحقق من إعدادات Proxy

#### حالة 500 - Server Error
**المشكلة**: خطأ في الخادم

**الحل**:
1. تحقق من سجلات Backend
2. تحقق من اتصال Backend بـ Google AI Studio
3. تحقق من حصة API (Quota)

#### "لم يتم استلام ملف صوتي"
**المشكلة**: الاستجابة لا تحتوي على بيانات صوتية

**الحل**:
1. ابحث عن "محتوى الاستجابة:" في console
2. انسخ البنية الكاملة
3. أرسلها لفريق Backend للتحقق

## قائمة التحقق للـ Backend

### ✅ المتطلبات الأساسية
- [ ] نقطة النهاية `/api-google-ai-studio/v1/text:synthesize` موجودة
- [ ] مفتاح Google AI Studio API مكون بشكل صحيح
- [ ] الصلاحيات صحيحة
- [ ] حصة API (Quota) كافية

### ✅ معالجة الطلب
- [ ] استقبال الطلب من Frontend
- [ ] التحقق من صحة البيانات
- [ ] إضافة مفتاح API
- [ ] إرسال الطلب إلى Google AI Studio

### ✅ معالجة الاستجابة
- [ ] استقبال الاستجابة من Google
- [ ] التحقق من نجاح الطلب
- [ ] إرجاع البيانات الصوتية إلى Frontend
- [ ] معالجة الأخطاء بشكل صحيح

## اختبار مباشر

### باستخدام curl
```bash
curl -X POST \
  https://api-integrations.appmedo.com/app-8bbt7fcnal1d/api-google-ai-studio/v1/text:synthesize \
  -H "Content-Type: application/json" \
  -H "X-App-Id: app-8bbt7fcnal1d" \
  -d '{
    "text": "مرحبا",
    "languageCode": "ar",
    "voiceName": "ar-XA-Wavenet-A",
    "speakingRate": 1.0,
    "pitch": 0.0,
    "audioEncoding": "MP3"
  }'
```

### الاستجابة المتوقعة
**نجاح**:
```json
{
  "audioContent": "base64_encoded_audio_data..."
}
```

أو

```
Content-Type: audio/mpeg
[binary audio data]
```

**فشل**:
```json
{
  "error": {
    "code": 401,
    "message": "API key not valid"
  }
}
```

## الخطوات التالية

### إذا استمرت المشكلة
1. **انسخ جميع السجلات** من console
2. **التقط screenshot** للخطأ
3. **سجل الطلب والاستجابة** الكاملة
4. **أرسل التفاصيل** لفريق الدعم

### معلومات مطلوبة للدعم
```
1. رسالة الخطأ الكاملة
2. سجلات console (جميع الأسطر)
3. النص الذي حاولت تحويله
4. اللغة والصوت المختار
5. الإعدادات (سرعة، نبرة)
6. وقت حدوث الخطأ
7. المتصفح المستخدم
```

## الخلاصة

تم تحديث الكود لحل المشكلة مع:
- ✅ نقطة نهاية جديدة
- ✅ هيكل طلب مبسط
- ✅ معالجة استجابة مرنة
- ✅ سجلات تفصيلية
- ✅ معالجة أخطاء شاملة

**الآن**: يجب على فريق Backend تكوين نقطة النهاية بشكل صحيح.

**التاريخ**: 2025-12-18
**الإصدار**: 2.3.0
